<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title>예약 조회</title>

  <!-- General CSS Files -->
  <link rel="stylesheet" href="assets/modules/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/modules/fontawesome/css/all.min.css">

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="assets/modules/bootstrap-daterangepicker/daterangepicker.css">
  <link rel="stylesheet" href="assets/modules/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <link rel="stylesheet" href="assets/modules/select2/dist/css/select2.min.css">
  <link rel="stylesheet" href="assets/modules/jquery-selectric/selectric.css">
  <link rel="stylesheet" href="assets/modules/bootstrap-timepicker/css/bootstrap-timepicker.min.css">
  <link rel="stylesheet" href="assets/modules/bootstrap-tagsinput/dist/bootstrap-tagsinput.css">

  <!-- Template CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/components.css">

  <!-- Firebase 연결하는 코드-->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
  <!-- Firebase -->
  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
      apiKey: "AIzaSyDRpI3eSY34j9tnVT5RSojCXyKahyTXjY0",
      authDomain: "capstone-51498.firebaseapp.com",
      databaseURL: "https://capstone-51498-default-rtdb.firebaseio.com",
      projectId: "capstone-51498",
      storageBucket: "capstone-51498.appspot.com",
      messagingSenderId: "509305643023",
      appId: "1:509305643023:web:3e88f2c4ac6e5668b4437a",
      measurementId: "G-MZKZ358C5T"
    };
    firebase.initializeApp(firebaseConfig);
  </script>


  <!-- Start GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-94034622-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-94034622-3');
  </script>
  <!-- /END GA -->
</head>

<body class="layout-3">
  <div id="app">
    <div class="main-wrapper container">
      <!-- 헤더 네비게이션 -->
      <div class="navbar-bg"></div>
      <nav class="navbar navbar-expand main-navbar">
        <a href="main.html" class="navbar-brand">RUN ON</a>
        <form class="form-inline ml-auto">
          <ul class="navbar-nav">
            <li><a href="#" data-toggle="search" class="nav-link nav-link-lg d-sm-none"></a></li>
          </ul>
        </form>
        <ul class="navbar-nav navbar-right">
          <li class="dropdown dropdown-list-toggle"><a href="#" data-toggle="dropdown"
              class="nav-link notification-toggle nav-link-lg beep"><i class="far fa-bell"></i></a>
            <div class="dropdown-menu dropdown-list dropdown-menu-right">
              <div class="dropdown-header">Notifications
                <div class="float-right">
                  <a href="#">Mark All As Read</a>
                </div>
              </div>
              <div class="dropdown-list-content dropdown-list-icons">
                <a href="#" class="dropdown-item dropdown-item-unread">
                  <div class="dropdown-item-icon bg-primary text-white">
                    <i class="fas fa-code"></i>
                  </div>
                  <div class="dropdown-item-desc">
                    Template update is available now!
                    <div class="time text-primary">2 Min Ago</div>
                  </div>
                </a>
              </div>
              <div class="dropdown-footer text-center">
                <a href="#">View All <i class="fas fa-chevron-right"></i></a>
              </div>
            </div>
          </li>
          <li class="dropdown">
            <a href="#" data-toggle="dropdown"
              class="nav-link dropdown-toggle nav-link-lg nav-link-user">
              <img alt="image" src="assets/img/avatar/avatar-1.png" class="rounded-circle mr-1">
              <div class="d-inline-block" id="name"></div>
            </a>
            <div class="dropdown-menu dropdown-menu-right" id="mypageLink">
              <!-- 여기 이름 -->
            </div>
          </li>
        </ul>
      </nav>

      <nav class="navbar navbar-secondary navbar-expand">
        <div class="container">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a href="./main.html" class="nav-link"><span>HOME</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link"><span class="fas fa-chevron-right text-muted"></span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link"><span class="text-primary">예약 조회</span></a>
            </li>
          </ul>
        </div>
      </nav>
      <!-- 네비게이션 여기까지 -->

      <!-- Main Content -->
      <div class="main-content">
        <section class="section">
          <div class="card">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h4>예약 내역 조회</h4>
                    <div class="card-header-action">
                      <div class="form-group">
                        <a href="javascript:;" class="btn btn-primary daterange-btn icon-left btn-icon">
                          <i class="fas fa-calendar"></i>조회 기간
                        </a>
                      </div>
                    </div>
                  </div>
                  <!-- 예약 내역 추가될 부분 -->
                  <div class="col-12" id="cardBody"></div>

                  <div class="card-footer text-center">
                    <nav class="d-inline-block">
                      <ul class="pagination mb-0">
                        <!-- 페이징 추가될 부분 -->
                      </ul>
                    </nav>
                  </div>

                </div>
              </div>
            </div>
        </section>
      </div>
      <footer class="main-footer">
        <div class="footer-left">
          Copyright &copy; 2018 <div class="bullet"></div> Design By <a href="https://nauval.in/">Muhamad Nauval
            Azhar</a>
        </div>
        <div class="footer-right">

        </div>
      </footer>
    </div>
  </div>

  <!-- General JS Scripts -->
  <script src="assets/modules/jquery.min.js"></script>
  <script src="assets/modules/popper.js"></script>
  <script src="assets/modules/tooltip.js"></script>
  <script src="assets/modules/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/modules/nicescroll/jquery.nicescroll.min.js"></script>
  <script src="assets/modules/moment.min.js"></script>
  <script src="assets/js/stisla.js"></script>

  <!-- JS Libraies -->
  <script src="assets/modules/cleave-js/dist/cleave.min.js"></script>
  <script src="assets/modules/cleave-js/dist/addons/cleave-phone.us.js"></script>
  <script src="assets/modules/jquery-pwstrength/jquery.pwstrength.min.js"></script>
  <script src="assets/modules/bootstrap-daterangepicker/daterangepicker.js"></script>
  <script src="assets/modules/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
  <script src="assets/modules/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
  <script src="assets/modules/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js"></script>
  <script src="assets/modules/select2/dist/js/select2.full.min.js"></script>
  <script src="assets/modules/jquery-selectric/jquery.selectric.min.js"></script>
  <script src="assets/modules/sweetalert/sweetalert.min.js"></script>

  <!-- Page Specific JS File -->
  <script src="assets/js/page/bootstrap-modal.js"></script>
  <script src="assets/js/page/modules-sweetalert.js"></script>

  <!-- Template JS File -->
  <script src="assets/js/scripts.js"></script>
  <script src="assets/js/custom.js"></script>
  <script>
    var uid = localStorage.getItem('uid');

    window.onload = function(){
      var uid = localStorage.getItem('uid');
      
      if(uid==null){
        swal("로그인이 필요한 기능입니다.", {
          icon: "warning",
        }).then(() => { location.href = 'index.html'; })
      }else{
        document.querySelector('#mypageLink').innerHTML 
          += '<a href="mypage.html" class="dropdown-item has-icon"><i class="far fa-user"></i>마이페이지</a>'
          + '<a href="index.html" class="dropdown-item has-icon text-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>';
      }

      viewReserve();
    }

    function goDetail(key) {
      sessionStorage.setItem('reserveKey', key)
      location.href = "./reserv_detail.html"
    }
    function findColor(n) {
      if (n == 0 || n == 1) return 'primary';
      else return 'secondary';
    }

    function findState(n) {
      if (n == 0) return 'primary">이용 예정';
      else if (n == 1) return 'primary">이용 중';
      else if (n == 2) return 'dark">이용 완료';
      else return 'muted">예약 취소';
    }

    function viewReserve() {
      const uid = window.localStorage.getItem('uid')
      var htmlString = '';

      // 2. 조회할 page 번호 가져오기
      //var curPage = get('page'); // 현재 page 번호
      var curPage = (new URL(document.location)).searchParams.get('page');
      if (curPage == null || curPage == '' || curPage == '#') curPage = 1; // 지정 없는 경우 첫 번째 page


      var query = firebase.database().ref('reserveData').orderByChild('userKey').equalTo(uid);
      var index = [];
      var maxPage, resNum;
      query.once('value').then(function (pageList) {
        resNum = pageList.numChildren();
        maxPage = Math.ceil(resNum / 10);

        var no = 0;
        pageList.forEach(function (page) {
          if (!(no % 10)) // 10배수인 경우
            index.push(page.key); // page 시작점 key 저장
          no++;
        })

        // 2-2. page 버튼 표시하기 (5개)
        var start = parseInt(curPage) - 2;
        var end = parseInt(curPage) + 2; // 현재 페이지 앞 뒤로 2

        if (curPage < 3 && maxPage > 5) end = 5;
        if (curPage < 3) start = 1;
        if (maxPage < 5) end = maxPage;
        if (curPage > 5 && curPage + 3 > maxPage) {
          start = maxPage - 4;
          end = maxPage;
        }

        var pageHtml = '';
        var pageLink = './reserv_history.html?page=';
        // 이전 페이지 (5페이지 이내 필요없음)
        if (maxPage > 5 && curPage > 3)
          pageHtml += '<li class="page-item">'
            + '<a class="page-link" href="' + pageLink + (curPage - 1) + '" tabindex="-1"><i class="fas fa-chevron-left"></i></a></li>';

        var i;
        for (i = start; i <= end; i++) {
          pageHtml += '<li class="page-item"><a class="page-link" href="' + pageLink + i + '">' + i;
          if (i == curPage) pageHtml += '<span class="sr-only">(current)</span>'; // 현재 페이지
          pageHtml += '</a></li>';
        }

        // 다음 페이지 (5페이지 이내 필요없음)
        if (maxPage > 5 && end != maxPage)
          pageHtml += '<li class="page-item">'
            + '<a class="page-link" href="' + pageLink + (end + 1) + '"><i class="fas fa-chevron-right"></i></a></li>'


        document.querySelector('.pagination').innerHTML = pageHtml; // html 추가
      }).then(function () {
        // 3. 현재 page 첫 번째 key부터 10개 가져오기
        var queryRes = firebase.database().ref('reserveData').orderByKey().startAt(index[curPage - 1])
        if (curPage < maxPage) // 마지막 page 아닌 경우 => 조회 끝 지점 정해주기
          queryRes = queryRes.endBefore(index[curPage]);

        queryRes.once('value').then(function (resList) {
          var no = ((curPage - 1) * 10) + 1;

          var htmlString = '';

          resList.forEach(function (childSnapshot) {
            var s = childSnapshot.val().state;

            var det = "goDetail('" + childSnapshot.key + "')"

            //state 0이용 전/1이용 중/2퇴실/3예약 취소
            htmlString += '<div class="card card-' + findColor(s) + '">'
              + '<div class="card-header">'
              + '<h4 class="text-' + findState(s) + '</h4>&nbsp;'
              + childSnapshot.val().date + ' | ' + childSnapshot.val().startTime + '~' + childSnapshot.val().endTime
              + '</div><div class="card-body text-dark">'
              + '도서관 제' + childSnapshot.val().room + '열람실 ' + childSnapshot.val().seat + '번 &nbsp;&nbsp;&nbsp;'
              + '<a onclick = ' + det + ' clas="text-muted">예약 상세&nbsp;＞</a>'
              + '</div></div>';
          })
          document.querySelector("#cardBody").innerHTML += htmlString;
        })
      })
    }

    const dbRef = firebase.database().ref();
    dbRef.child("userInfo").child(uid).get().then((snapshot) => {
      const nameArea = document.getElementById('name');
      const userName = snapshot.val().name
      window.localStorage.setItem('userName', userName)
      nameArea.append(userName)
    }).catch((error) => {
      console.error(error);
    });
  </script>
</body>

</html>
